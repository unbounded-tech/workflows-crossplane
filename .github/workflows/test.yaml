name: test

on:
  workflow_call:
    inputs:
      ghcr_user:
        description: 'ghcr user'
        required: false
        type: string

      crossplane_version:
        description: 'Crossplane CLI version to install'
        required: false
        type: string
        default: 'v2.0.2'

      pattern:
        description: 'Test file pattern'
        required: false
        type: string
        default: 'tests/test*'

    secrets:
      GH_PAT:
        description: 'Token for ghcr.io package write access'
        required: false

permissions:
  contents: read
  packages: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache upbound + crossplane
        uses: actions/cache@v5
        with:
          path: |
            ~/.crossplane/cache
            ~/.up/cache
            ~/.up/build-cache
          key: ${{ runner.os }}-crossplane-${{ hashFiles('**/upbound.yaml','**/definition.yaml') }}-

      - name: Install & login with up
        uses: upbound/action-up@v1.0.0
        with:
          skip-login: true

      - name: Install Crossplane CLI
        run: |
          curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh \
            | XP_VERSION=${{ inputs.crossplane_version }} sh

      - name: check for GH_PAT if ghcr_user is set
        if: inputs.ghcr_user
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "GH_PAT secret must be set if ghcr_user is set"
            exit 1
          fi

      - name: Docker login to GHCR
        if: inputs.ghcr_user
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ inputs.ghcr_user }}
          password: ${{ secrets.GH_PAT }}

      - name: Docker login to GHCR
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build with up
        uses: upbound/action-up-project@v1.1.2
        with:
          skip-login-check: true

      - name: Install crane
        run: |
          # Install crane for pulling OCI packages
          CRANE_VERSION="v0.20.2"
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar -xzf - crane
          sudo mv crane /usr/local/bin/

      - name: Pre-pull Docker images
        run: |
          # Pre-pull images used by `up` CLI to prevent timeout issues
          # Pull all images in parallel for faster startup
          echo "Pre-pulling Docker images in parallel..."

          # Standard Docker images
          docker pull kindest/node:v1.33.1 --quiet &

          # Extract and pull function/provider packages from upbound.yaml using crane
          if [ -f upbound.yaml ]; then
            echo "Pulling functions from upbound.yaml..."
            yq -r '.spec.dependsOn[] | select(.kind == "Function") | .package' upbound.yaml 2>/dev/null | while read pkg; do
              if [ -n "$pkg" ]; then
                echo "Pre-pulling function: $pkg"
                crane pull "$pkg" /dev/null 2>/dev/null &
              fi
            done

            echo "Pulling providers from upbound.yaml..."
            yq -r '.spec.dependsOn[] | select(.kind == "Provider") | .package' upbound.yaml 2>/dev/null | while read pkg; do
              if [ -n "$pkg" ]; then
                echo "Pre-pulling provider: $pkg"
                crane pull "$pkg" /dev/null 2>/dev/null &
              fi
            done
          fi

          # Wait for all background pulls to complete
          wait
          echo "All images pre-pulled"
        timeout-minutes: 5

      - name: Test
        run: |
          up test run ${{ inputs.pattern }}
