name: validate

on:
  workflow_call:
    inputs:
      ghcr_user:
        description: 'ghcr user'
        required: false
        type: string

      composition:
        description: 'Composition YAML filename (default: composition.yaml)'
        required: false
        type: string
        default: 'composition.yaml'

      examples:
        description: 'JSON array of example objects with path and optional observed_resources'
        required: true
        type: string
        default: '[]'

      crossplane_version:
        description: 'Crossplane CLI version to install'
        required: false
        type: string
        default: 'v2.0.2'

      api_path:
        description: 'Path to your API directory'
        required: true
        type: string

      error_on_missing_schemas:
        description: 'Whether to error on missing schemas during validation'
        required: false
        type: boolean
        default: true

    secrets:
      GH_PAT:
        description: 'Token for ghcr.io package write access'
        required: false

permissions:
  contents: read
  packages: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.process.outputs.examples }}
    steps:
      - name: Process examples matrix
        id: process
        run: |
          examples='${{ inputs.examples }}'

          # Normalize: try to parse and compact as JSON first
          if normalized=$(echo "$examples" | jq -c '.' 2>/dev/null); then
            examples="$normalized"
          fi

          # Check if input is valid JSON (array) or plain string
          if echo "$examples" | jq -e 'type == "array"' >/dev/null 2>&1; then
            # It's a JSON array
            if echo "$examples" | jq -e '.[0] | type == "string"' >/dev/null 2>&1; then
              # Array of strings: convert to array of objects
              processed=$(echo "$examples" | jq -c 'map({"example": .})')
            else
              # Already array of objects: use as-is (compact)
              processed=$(echo "$examples" | jq -c '.')
            fi
          else
            # Single string: convert to array containing one object
            processed=$(echo "$examples" | jq -Rc '[{"example": .}]')
          fi

          echo "examples=$processed" >> $GITHUB_OUTPUT

  validate:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # See all results
      matrix:
        example: ${{ fromJSON(needs.setup.outputs.examples) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache upbound + crossplane
        uses: actions/cache@v5
        with:
          path: |
            ~/.crossplane/cache
            ~/.up/cache
            ~/.up/build-cache
          key: ${{ runner.os }}-crossplane-${{ hashFiles('**/upbound.yaml','**/definition.yaml') }}-

      - name: Install & login with up
        uses: upbound/action-up@v1.0.0
        with:
          skip-login: true

      - name: Install Crossplane CLI
        run: |
          curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh \
            | XP_VERSION=${{ inputs.crossplane_version }} sh

      - name: check for GH_PAT if ghcr_user is set
        if: inputs.ghcr_user
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "GH_PAT secret must be set if ghcr_user is set"
            exit 1
          fi

      - name: Docker login to GHCR
        if: inputs.ghcr_user
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ inputs.ghcr_user }}
          password: ${{ secrets.GH_PAT }}

      - name: Docker login to GHCR
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build with up
        uses: upbound/action-up-project@v1.1.2
        with:
          skip-login-check: true

      - name: Install crane
        run: |
          # Install crane for pulling OCI packages
          CRANE_VERSION="v0.20.2"
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar -xzf - crane
          sudo mv crane /usr/local/bin/

      - name: Pre-pull Docker images
        run: |
          # Pre-pull images used by `up` CLI to prevent timeout issues
          # Pull all images in parallel for faster startup
          echo "Pre-pulling Docker images in parallel..."

          # Create temp directory for logs
          LOGDIR=$(mktemp -d)

          # Standard Docker images (kindest/node is public on Docker Hub)
          docker pull kindest/node:v1.33.1 > "$LOGDIR/docker-kindest-node.log" 2>&1 &

          # Upbound internal images used by `up` CLI (from xpkg.upbound.io)
          crane pull xpkg.upbound.io/upbound/olareg:v0.1.2 /dev/null > "$LOGDIR/upbound-olareg.log" 2>&1 &
          crane pull xpkg.upbound.io/upbound/datamodel-code-generator:v0.31.2 /dev/null > "$LOGDIR/upbound-datamodel-code-generator.log" 2>&1 &
          crane pull xpkg.upbound.io/upbound/kcl:v0.11.2 /dev/null > "$LOGDIR/upbound-kcl.log" 2>&1 &
          crane pull xpkg.upbound.io/upbound/function-go-templating-base:v0.9.0-13-gd1fa2e3 /dev/null > "$LOGDIR/upbound-function-go-templating-base.log" 2>&1 &

          # Extract and pull function/provider/configuration packages from upbound.yaml using crane
          if [ -f upbound.yaml ]; then
            # Pull functions
            yq -r '.spec.dependsOn[] | select(.kind == "Function") | .package' upbound.yaml 2>/dev/null | while read pkg; do
              if [ -n "$pkg" ]; then
                name=$(echo "$pkg" | sed 's|.*/||' | sed 's/:/-/g')
                crane pull "$pkg" /dev/null > "$LOGDIR/function-$name.log" 2>&1 &
              fi
            done

            # Check if any provider-aws-* is used, if so pull provider-family-aws once
            first_aws_pkg=$(yq -r '.spec.dependsOn[] | select(.kind == "Provider") | .package' upbound.yaml 2>/dev/null | grep "provider-aws-" | head -1)
            if [ -n "$first_aws_pkg" ]; then
              family_pkg=$(echo "$first_aws_pkg" | sed 's/provider-aws-[^:]*:/provider-family-aws:/')
              name=$(echo "$family_pkg" | sed 's|.*/||' | sed 's/:/-/g')
              crane pull "$family_pkg" /dev/null > "$LOGDIR/provider-$name.log" 2>&1 &
            fi

            # Pull providers
            yq -r '.spec.dependsOn[] | select(.kind == "Provider") | .package' upbound.yaml 2>/dev/null | while read pkg; do
              if [ -n "$pkg" ]; then
                name=$(echo "$pkg" | sed 's|.*/||' | sed 's/:/-/g')
                crane pull "$pkg" /dev/null > "$LOGDIR/provider-$name.log" 2>&1 &
              fi
            done

            # Pull configurations
            yq -r '.spec.dependsOn[] | select(.kind == "Configuration") | .package' upbound.yaml 2>/dev/null | while read pkg; do
              if [ -n "$pkg" ]; then
                name=$(echo "$pkg" | sed 's|.*/||' | sed 's/:/-/g')
                crane pull "$pkg" /dev/null > "$LOGDIR/configuration-$name.log" 2>&1 &
              fi
            done
          fi

          # Wait for all background pulls to complete
          wait

          # Display organized logs
          echo ""
          echo "=== Pre-pull Results ==="
          for logfile in "$LOGDIR"/*.log; do
            if [ -f "$logfile" ]; then
              name=$(basename "$logfile" .log)
              echo ""
              echo "--- $name ---"
              cat "$logfile"
            fi
          done

          # Cleanup
          rm -rf "$LOGDIR"
          echo ""
          echo "All images pre-pulled"
        timeout-minutes: 5

      - name: Render Example
        run: |
          observed_flag=""
          if [ -n "${{ matrix.example.observed_resources }}" ]; then
            observed_flag="--observed-resources=${{ matrix.example.observed_resources }}"
          fi
          up composition render \
            ${{ inputs.api_path }}/${{ inputs.composition }} \
            ${{ matrix.example.example }} \
            $observed_flag

      - name: Validate Example
        run: |
          ./crossplane beta validate ${{ matrix.example.example }} ${{ inputs.api_path }}

      - name: Validate Rendered Example
        run: |
          flag=""
          if [ "${{ inputs.error_on_missing_schemas }}" = "true" ]; then
            flag="--error-on-missing-schemas"
          fi
          observed_flag=""
          if [ -n "${{ matrix.example.observed_resources }}" ]; then
            observed_flag="--observed-resources=${{ matrix.example.observed_resources }}"
          fi
          up composition render \
            ${{ inputs.api_path }}/${{ inputs.composition }} \
            ${{ matrix.example.example }} \
            --include-full-xr --quiet \
            $observed_flag \
          | ./crossplane beta validate ${{ inputs.api_path }} $flag -
